---
title: 观察
sidebarTitle: 观察
description: "为你的工作流查找推荐的动作"
---

## 什么是 `observe()`？ {#what-is-observe}

```typescript
page.observe("Find the login button")
```

`observe()` 让你将任意页面转化为一份可靠、可执行的动作清单。它会发现关键元素、为可能的下一步操作排序，并返回结构化动作（selector、method、arguments），你可以立即用 `act()` 执行，或用来精确定位 `extract()`，从而让工作流更快、更省成本、更具鲁棒性。

## 为什么使用 `observe()`？ {#why-use-observe}

<CardGroup cols={2}>
  <Card title="Explore" icon="compass" href="/zh/basics/observe#observe-with-act">
    当你不确定页面内容，或需要发现可用的操作时
  </Card>

  <Card title="Plan" icon="map" href="/zh/basics/observe#plan-ahead">
    在构建复杂工作流时，预先规划所有需要执行的操作
  </Card>

  <Card title="Cache" icon="database" href="/zh/best-practices/caching">
    当你想保存操作以供后续复用，并避免调用 LLM 时
  </Card>

  <Card title="Validate" icon="check" href="/zh/basics/observe#observe-with-act">
    在执行关键操作前验证目标元素是否存在
  </Card>
</CardGroup>

## 使用 `observe()` {#using-observe}

调用 `observe` 可大幅增强其他 Stagehand 方法。用它来规划工作流、加速 `act`，并精确定位 `extract`。`observe` 会返回一组建议动作，帮助你探索页面上可执行的操作。

<CodeGroup>
  ```typescript TypeScript
  // 规划与验证
  const buttons = await page.observe("Find the log in / sign up buttons");
  ```

  ```python Python
  # 规划与验证
  buttons = await page.observe("Find the log in / sign up buttons")
  ```
</CodeGroup>

这将返回一个具有以下结构的建议列表：

```json
{
  "selector": "xpath=/html/body/header/div/button[1]",
  "description": "右上角的登录按钮",
  "method": "click",
  "arguments": []
}
```

### 搭配 Act 使用 {#observe-with-act}

你可以先“验证”动作（method、selector、arguments 等），然后将其传给 `act`，从而避免额外的 LLM 推理。

<Note>
  **性能提示**：对多个 `observe` 建议直接执行操作，可将多步动作的 LLM 调用次数降到最低，使工作流提速 2-3 倍。
</Note>

<CodeGroup>
  ```typescript TypeScript
  await page.act(buttons[0]); // 无需调用 LLM！
  ```

  ```python Python
  await page.act(buttons[0]) # 无需调用 LLM！
  ```
</CodeGroup>

#### 提前规划 {#plan-ahead}

你可以利用 `observe` 的多条建议来预览并批量执行操作。例如，填写表单时可让 `observe` 找到所有字段，再逐一传给 `act`。**LLM 调用一次，多次执行 act**。

<CodeGroup>
  ```typescript TypeScript
  const fields = await page.observe("Find all the fields in the form");
  for (const field of fields) {
    await page.act(field); // 无需调用 LLM！
  }
  ```

  ```python Python
  fields = await page.observe("Find all the fields in the form")
  for field in fields:
    await page.act(field) # 无需调用 LLM！
  ```
</CodeGroup>

### Observe 与 Extract {#observe-and-extract}

使用 `observe` 将 `extract` 聚焦到页面的特定区域（例如表格、表单、列表等），可将提取所需的上下文最小化。

<Tip>
  **节省成本提示**：将 selector 传给 `extract`，在内容冗长的网站上可将 LLM token 使用量减少 10 倍！
</Tip>

<CodeGroup>
  ```typescript TypeScript
  // 在提取前用 observe 验证元素
  const [ table ] = await page.observe("Find the data table");

  const { data } = await page.extract({
    instruction: "Extract data from the table",
    schema: z.object({
      data: z.string()
    }),
    selector: table.selector // 缩小提取所需的上下文范围
  });
  ```

  ```python Python
  # 在提取前用 observe 验证元素
  [ table ] = await page.observe("Find the data table")

  extraction = await page.extract(
    "Extract data from the table",
    schema=Data, # Pydantic 模式
    selector=table.selector # 缩小提取所需的上下文范围
  )
  ```
</CodeGroup>

## 最佳实践 {#best-practices}

### 选择合适的命令 {#choose-the-right-commands}

<Tabs>
  <Tab title="这样做">
    - 当某个是/否答案会决定后续动作时，使用 `observe`（例如，“找到 Submit 按钮”），然后按条件执行 `act`。
    - 对纯信息类问题使用 `extract`（例如，“页面标题是什么？”、“列出了多少个结果？”）。
  </Tab>

  <Tab title="不要这样做">
    - 不要为了定位接下来要点击的元素而调用 `extract`。
    - 对不会引发后续动作的纯信息类问题，不要调用 `observe`。
  </Tab>
</Tabs>

- **用 `observe` 进行发现与规划**：使用 `observe("Find…")` 映射可操作元素并预览下一步。
- **用 `observe` 返回的选择器限定 `extract` 范围**：先 `observe("Find the data table")`，再将 `selector` 传给 `extract`，以减少 Token 并提升准确性。

### 节省 LLM Token {#conserve-llm-tokens}

通过将 `ObserveResult` 直接传给 `act`（例如，`await page.act(results[0])`）来优化性能并节省 LLM Token。可先用一次 `observe` 批量发现元素，然后逐一执行动作。对熟悉的页面缓存并复用稳定的 `observe` 结果，布局变化时依赖自愈能力。

<Card title="构建你自己的缓存" icon="database" href="/zh/best-practices/caching">
  查看如何构建动作缓存的指南
</Card>

### 提高准确性 {#improve-accuracy}

指令要精确，例如，“在 hero 中找到主 CTA”能获得更好结果。对于 iframe，设置 `iframes: true` 并等待 `networkidle`。在 `extract` 中使用来自 `observe` 的选择器以收窄上下文。

<Card title="提示工程最佳实践" icon="robot" href="/zh/best-practices/prompting-best-practices">
  查看如何提升结果准确性的指南
</Card>

### 动作验证 {#action-validation}

在执行关键动作前，验证建议的 `method`、`selector` 和 `arguments`，以防误点。如果直接 `act` 失败，使用相同提示调用 `observe` 验证方法，然后按建议的动作继续。

<CodeGroup>
  ```typescript TypeScript
  const prompt = "click the submit button";
  const expectedMethod = "click";

  try {
    await page.act(prompt);
  } catch (error) {
    if (error.message.includes("method not supported")) {
      // 观察相同的提示以获取计划的动作
      const [action] = await page.observe(prompt);
      
      if (action && action.method === expectedMethod) {
        await page.act(action);
      } else {
        throw new Error(`Unsupported method: expected "${expectedMethod}", got "${action?.method}"`);
      }
    } else {
      throw error;
    }
  }
  ```

  ```python Python
  prompt = "click the submit button"
  expected_method = "click"

  try:
      await page.act(prompt)
  except Exception as error:
      if "method not supported" in str(error):
          # 观察相同的提示以获取计划的动作
          results = await page.observe(prompt)
          
          if results and results[0].method == expected_method:
              await page.act(results[0])
          else:
              method = results[0].method if results else "unknown"
              raise Exception(f'Unsupported method: expected "{expected_method}", got "{method}"')
      else:
          raise error
  ```
</CodeGroup>

## 故障排查 {#troubleshooting}

<AccordionGroup>
  <Accordion title="未找到元素">
    **问题**：`observe()` 返回空数组

    **解决方案**：

    - 确认页面上存在该元素
    - 使用更明确的指令定位该元素
    - 确保页面已完全加载
    - 查看[调试工作流](/zh/best-practices/debugging-workflows)日志；如果日志中能看到该元素，可能是 LLM 产生幻觉/未捕获到
  </Accordion>

  <Accordion title="元素描述不准确">
    **问题**：描述与实际元素不匹配

    **解决方案**：

    - 使用更强的模型：查看 [评估套件与仪表板，用于比较 Stagehand 任务的模型性能与成本](https://stagehand.dev/evals)，选择最适合你用例的模型
    - 提供更具体的指令
    - 将推理过程记录到文件（参见[调试工作流](/zh/best-practices/debugging-workflows)）以获取 LLM 追踪
  </Accordion>

  <Accordion title="识别了错误的方法">
    **问题**：识别的方法无效

    **解决方案**：

    - 查看[支持的动作](/zh/basics/act)
    - 提供更具体的指令
    - 校验该方法；如无效，改用受支持的方法
  </Accordion>
</AccordionGroup>

## 后续步骤 {#next-steps}

<CardGroup cols={2}>
  <Card title="Act Overview" icon="play" href="/zh/basics/act">
    利用 observe() 结果高效执行动作
  </Card>

  <Card title="Extract Data" icon="download" href="/zh/basics/extract">
    从已观察到的元素提取结构化数据
  </Card>

  <Card title="Observability" icon="chart-line" href="/zh/configuration/observability">
    监控与调试观察性能
  </Card>

  <Card title="Best Practices" icon="star" href="/zh/best-practices/best-practices">
    高级模式与优化方法
  </Card>
</CardGroup>
